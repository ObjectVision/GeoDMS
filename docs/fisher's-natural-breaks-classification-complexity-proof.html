<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <link rel="stylesheet" href="/assets/css/just-the-docs-head-nav.css" id="jtd-head-nav-stylesheet"> <style id="jtd-nav-activation"> .site-nav ul li a { background-image: none; } </style> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="icon" href="/favicon.ico" type="image/x-icon"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>fisher’s-natural-breaks-classification-complexity-proof | GeoDMS wiki</title> <meta name="generator" content="Jekyll v4.3.2" /> <meta property="og:title" content="fisher’s-natural-breaks-classification-complexity-proof" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="A starter template for a Jeykll site using the Just the Docs theme!" /> <meta property="og:description" content="A starter template for a Jeykll site using the Just the Docs theme!" /> <link rel="canonical" href="http://localhost:4000/docs/fisher's-natural-breaks-classification-complexity-proof.html" /> <meta property="og:url" content="http://localhost:4000/docs/fisher's-natural-breaks-classification-complexity-proof.html" /> <meta property="og:site_name" content="GeoDMS wiki" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="fisher’s-natural-breaks-classification-complexity-proof" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"A starter template for a Jeykll site using the Just the Docs theme!","headline":"fisher’s-natural-breaks-classification-complexity-proof","url":"http://localhost:4000/docs/fisher's-natural-breaks-classification-complexity-proof.html"}</script> <!-- End Jekyll SEO tag --> <!-- Automatically display code inside script tags with type=math/tex using MathJax --> <script type="text/javascript" defer src="../assets/js/mathjax-script-type.js"> </script> <!-- Copied from https://docs.mathjax.org/en/latest/web/components/combined.html --> <script type="text/javascript" id="MathJax-script" defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"> </script> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" class="d-none"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <!-- Bootstrap Icons. MIT License: https://github.com/twbs/icons/blob/main/LICENSE.md --> <symbol id="svg-copy" viewBox="0 0 16 16"> <title>Copy</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/> <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/> </svg> </symbol> <symbol id="svg-copied" viewBox="0 0 16 16"> <title>Copied</title> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard-check-fill" viewBox="0 0 16 16"> <path d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z"/> <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1Zm6.854 7.354-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L7.5 10.793l2.646-2.647a.5.5 0 0 1 .708.708Z"/> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header" role="banner"> <a href="/" class="site-title lh-tight"> GeoDMS wiki </a> <button id="menu-button" class="site-button btn-reset" aria-label="Toggle menu" aria-pressed="false"> <svg viewBox="0 0 24 24" class="icon" aria-hidden="true"><use xlink:href="#svg-menu"></use></svg> </button> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">home</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in software category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/software.html" class="nav-list-link">software</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/system-requirements.html" class="nav-list-link">system-requirements</a></li><li class="nav-list-item"><a href="/docs/installation-instructions.html" class="nav-list-link">installation-instructions</a></li><li class="nav-list-item"><a href="/docs/folders-and-placeholders.html" class="nav-list-link">folders-and-placeholders</a></li><li class="nav-list-item"><a href="/docs/configuration-file-editor.html" class="nav-list-link">configuration-file-editor</a></li><li class="nav-list-item"><a href="/docs/known-issues.html" class="nav-list-link">known-issues</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in user-guide category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/user-guide.html" class="nav-list-link">user-guide</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/user-guide-geodms-gui.html" class="nav-list-link">user-guide-geodms-gui</a></li><li class="nav-list-item"><a href="/docs/user-guide-geodms-gui-older-variants-(delphi).html" class="nav-list-link">user-guide-geodms-gui-older-variants-(delphi)</a></li><li class="nav-list-item"><a href="/docs/user-guide-geodms-run.html" class="nav-list-link">user-guide-geodms-run</a></li></ul></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in how-to-model category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/how-to-model.html" class="nav-list-link">how-to-model</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/configuration-basics.html" class="nav-list-link">configuration-basics</a></li><li class="nav-list-item"><a href="/docs/unit.html" class="nav-list-link">unit</a></li><li class="nav-list-item"><a href="/docs/data-source.html" class="nav-list-link">data-source</a></li><li class="nav-list-item"><a href="/docs/expression.html" class="nav-list-link">expression</a></li><li class="nav-list-item"><a href="/docs/template.html" class="nav-list-link">template</a></li><li class="nav-list-item"><a href="/docs/visualisation-style.html" class="nav-list-link">visualisation-style</a></li><li class="nav-list-item"><a href="/docs/property.html" class="nav-list-link">property</a></li></ul></li><li class="nav-list-item"><a href="/docs/value-type.html" class="nav-list-link">value-type</a></li><li class="nav-list-item"><a href="/docs/configuration-examples.html" class="nav-list-link">configuration-examples</a></li><li class="nav-list-item"><button class="nav-list-expander btn-reset" aria-label="toggle items in operator category" aria-pressed="false"> <svg viewBox="0 0 24 24" aria-hidden="true"><use xlink:href="#svg-arrow-right"></use></svg> </button><a href="/docs/operator.html" class="nav-list-link">operator</a><ul class="nav-list"><li class="nav-list-item"><a href="/docs/arithmetic-functions.html" class="nav-list-link">arithmetic-functions</a></li><li class="nav-list-item"><a href="/docs/ordering-functions.html" class="nav-list-link">ordering-functions</a></li><li class="nav-list-item"><a href="/docs/aggregation-functions.html" class="nav-list-link">aggregation-functions</a></li><li class="nav-list-item"><a href="/docs/conversion-functions.html" class="nav-list-link">conversion-functions</a></li><li class="nav-list-item"><a href="/docs/classify-functions.html" class="nav-list-link">classify-functions</a></li><li class="nav-list-item"><a href="/docs/transcendental-functions.html" class="nav-list-link">transcendental-functions</a></li><li class="nav-list-item"><a href="/docs/predicates-functions.html" class="nav-list-link">predicates-functions</a></li><li class="nav-list-item"><a href="/docs/logical-functions.html" class="nav-list-link">logical-functions</a></li><li class="nav-list-item"><a href="/docs/relational-functions.html" class="nav-list-link">relational-functions</a></li><li class="nav-list-item"><a href="/docs/selection-functions.html" class="nav-list-link">selection-functions</a></li><li class="nav-list-item"><a href="/docs/rescale-functions.html" class="nav-list-link">rescale-functions</a></li><li class="nav-list-item"><a href="/docs/constant-functions.html" class="nav-list-link">constant-functions</a></li><li class="nav-list-item"><a href="/docs/trigonometric-functions.html" class="nav-list-link">trigonometric-functions</a></li><li class="nav-list-item"><a href="/docs/geometric-functions.html" class="nav-list-link">geometric-functions</a></li><li class="nav-list-item"><a href="/docs/network-functions.html" class="nav-list-link">network-functions</a></li><li class="nav-list-item"><a href="/docs/grid-functions.html" class="nav-list-link">grid-functions</a></li><li class="nav-list-item"><a href="/docs/string-functions.html" class="nav-list-link">string-functions</a></li><li class="nav-list-item"><a href="/docs/file,-folder-and-read-functions.html" class="nav-list-link">file,-folder-and-read-functions</a></li><li class="nav-list-item"><a href="/docs/unit-functions.html" class="nav-list-link">unit-functions</a></li><li class="nav-list-item"><a href="/docs/matrix-functions.html" class="nav-list-link">matrix-functions</a></li><li class="nav-list-item"><a href="/docs/sequence-functions.html" class="nav-list-link">sequence-functions</a></li><li class="nav-list-item"><a href="/docs/metascript-functions.html" class="nav-list-link">metascript-functions</a></li><li class="nav-list-item"><a href="/docs/allocation-functions.html" class="nav-list-link">allocation-functions</a></li><li class="nav-list-item"><a href="/docs/miscellaneous-functions.html" class="nav-list-link">miscellaneous-functions</a></li></ul></li></ul> </nav> <footer class="site-footer"> </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search" role="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search GeoDMS wiki" aria-label="Search GeoDMS wiki" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://github.com/ObjectVision/GeoDMS" class="site-button" > GeoDms on Github </a> </li> </ul> </nav> </div> <div class="main-content-wrap"> <div id="main-content" class="main-content"> <main> <p>An <strong><em>O(k × n × log(n))</em></strong> algorithm is presented here, with proof of its validity and complexity, for the <a href="classification">classification</a> of an array of <em>n</em> numeric values into <em>k</em> classes such that the sum of the squared deviations from the class means is minimal, known as Fisher’s Natural Breaks Classification. This algorithm is an improvement of <a href="http://en.wikipedia.org/wiki/Jenks_natural_breaks_optimization">Jenks’ Natural Breaks Classification Method</a>, which is a (re)implementation of the algorithm described by Fisher within the context of <a href="http://en.wikipedia.org/wiki/Choropleth_map">choropleth maps</a>, which has time complexity <strong><em>O(k × n <sup>2</sup>)</em></strong>.</p> <p>Finding breaks for 15 classes for a data array of 7 million unique values now takes 20 seconds on a desktop PC.</p> <h1 id="definitions"> <a href="#definitions" class="anchor-heading" aria-labelledby="definitions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> definitions </h1> <p>Given a sequence of strictly increasing values <strong><em>v<sub>i</sub></em></strong> and positive weights <strong><em>w<sub>i</sub></em></strong> for <strong><em>i ? {1..n}</em></strong>, and a given number of classes <strong><em>k</em></strong> with <strong><em>k = n</em></strong>,</p> <p>choose classification function <strong><em>I(x)</em></strong> : {1..<strong><em>n</em></strong>} ? {1..<strong><em>k</em></strong>}, such that ***SSD<sub>n, k***</sub>, the sum of the squares of the deviations from the class means, is minimal, where:</p> \[\\begin{align} SSD_{n,k} &amp;:= \\min\\limits_{I: \\{1..n\\} \\to \\{1..k\\}} \\sum\\limits^k_{j=1} ssd(S_j) &amp; &amp; \\text{minimal sum of sum of squared deviations } \\\\ S_j &amp;:= \\{i\\in \\{1..n\\}\|I(i) = j\\} &amp; &amp; \\text{set of indices that map to class}\\,j\\\\ ssd(S) &amp;:= { \\sum\\limits_{i \\in S} {w_i (v_i - m(S))^2} } &amp; &amp; \\text{the sum of squared deviations of the values of any index set}\\,S\\\\ m(S) &amp;:= { s(S) \\over w(S) } &amp; &amp; \\text{the weighted mean of the values of any index set}\\,S\\\\ s(S) &amp;:= { \\sum\\limits_{i \\in S} {w_i v_i} } &amp; &amp; \\text{the weighted sum of the values of any index set}\\,S\\\\ w(S) &amp;:= \\sum\\limits_{i \\in S} {w_i} &amp; &amp; \\text{the sum of the value-weights of any index set}\\,S \\end{align}\] <p>Note that any array of n unsorted and not necessarily unique values can be sorted and made into unique <em><strong>v<sub>i***</sub> by removing duplicates with ***w<sub>i***</sub> representing the occurrence frequency of each value in ***O(nlog(n))</strong></em> time.</p> <h1 id="characteristics"> <a href="#characteristics" class="anchor-heading" aria-labelledby="characteristics"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> characteristics </h1> <p>One can derive the following:</p> <ul> <li><strong><em>ssd(S) = sqr(S) - wsm(S)</em></strong> with</li> </ul> \[\\begin{align} sqr(S) &amp;:= \\sum\\limits_{i \\in S} {w_i {v_i}^2} \\\\ wsm(S) &amp;:= {w(S) {m(S)}^2} = s(S) m(S) &amp; &amp;\\text{the weighted square of the mean of S} \\end{align}\] <ul> <li><strong><em>SSD</em></strong> = <strong><em>SSV</em></strong> - <strong><em>WSM</em></strong> with</li> </ul> \[\\begin{align} SSV &amp;:= \\sum\\limits_{j} {sqr(S_j)} = sqr(\\{1..n\\}) \\\\ WSM &amp;:= \\sum\\limits_{j} {wsm(S_j)} = \\sum\\limits_{j} {w(S_j) {m(S_j)}^2} = \\sum\\limits_{j} { {s(S_j)}^2 \\over w(S_j)} \\end{align}\] <ul> <li>Since <strong><em>SSV</em></strong> is independent of the chosen partitioning <strong><em>S<sub>j</sub></em></strong>, minimizing <strong><em>SSD</em></strong> is equivalent to maximizing:</li> </ul> \[WSM = \\sum\\limits_{j} { {\[\\sum\\limits_{i \\in S_j} {w_i v_i}\]^2} \\over {\\sum\\limits_{i \\in S_j} {w_i}} }\] <ul> <li>Since the sequence <strong><em>v</em></strong> is sorted, all <em><strong>v<sub>i***</sub>’s that belong to one class ***S<sub>j***</sub> must be consecutive and if equal values would be allowed, these would end up in the same class provided that at least ***k</strong></em> unique values are given (for proof, see: Fisher, On Grouping for Maximum Homogeneity, 1958). Consequently, the <strong><em>S<sub>j***</sub>’s can be 1-to-1 related to a strictly increasing sequence of class-break-indices *i</em><sub>**<em>j</em>**</sub> := min **<em>S<sub>j***</sub> for **</em>j</strong>* = 1..<strong><em>k</em></strong> with <strong><em>i</em></strong><sub>1</sub> = 1 and also to a strictly increasing sequence of class-break-values <strong><em>v<sub>i<sub>j</sub></sub></em></strong>.</li> </ul> <!-- --> <ul> <li>With <strong><em>n</em></strong> values and <strong><em>k</em></strong> classes, one can choose $\binom{n-1}{k-1} = \frac{(n-1)!}{(k-1)! (n-k)!}$ elements as first value of a class (the minimum value must be the minimum of the lowest class).</li> </ul> <!-- --> <ul> <li>given indices <strong><em>i</em></strong><sub>1</sub> = <strong><em>i</em></strong><sub>2</sub> and <strong><em>i</em></strong><sub>3</sub> = <strong><em>i</em></strong><sub>4</sub>: <strong><em>i</em></strong><sub>1</sub> = <strong><em>i</em></strong><sub>3</sub> ? <strong><em>i</em></strong><sub>2</sub> = <strong><em>i</em></strong><sub>4</sub> ? <strong><em>m(i<sub>1</sub>..i</em></strong><sub><strong><em>2</em></strong></sub>) = <strong><em>m(i<sub>3</sub>..i</em></strong><sub><strong><em>4</em></strong></sub>)</li> </ul> <h1 id="dynamic-programming-approach"> <a href="#dynamic-programming-approach" class="anchor-heading" aria-labelledby="dynamic-programming-approach"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> dynamic programming approach </h1> <p>Take <em><strong>SSM<sub>i,j***</sub> as the maximum sum of squared deviations for the first i values classified to j classes and ***CB<sub>i,j***</sub> as the value index of the last class-break for such classification. Since a maximal sum is a sum, it is easy to see that ***SSM<sub>i,j***</sub> is equal to the maximum value for ***p</strong></em> ? {<strong><em>j</em></strong>..<strong><em>i</em></strong>} of <strong><em>SSM<sub>p*** - 1, ***j*** - 1</sub> + **</em>ssm</strong><em>({</em><strong>p</strong><em>..</em><strong>i</strong><em>}) . Thus, the <strong>*SSM</strong></em><sub><strong><em>p</em></strong> - 1, <strong><em>j</em></strong> - 1</sub> provide <a href="http://en.wikipedia.org/wiki/Overlapping_subproblem">Overlapping Sub Problems</a> with an <a href="http://en.wikipedia.org/wiki/Optimal_substructure">Optimal Sub Structure</a> and the following dynamic program can be used to find a solution.</p> <p>Dynamic rule for <strong><em>i</em></strong> = <strong><em>j</em></strong> &gt; 1:</p> \[\\begin{align} SSM_{i,j} &amp;:= \\max\\limits_{p \\in \\{j..i\\}} SSM_{p-1, j-1}+ssm(\\{p..i\\}) \\\\ CB_{i,j} &amp;:= arg\\max\\limits_{p \\in \\{j..i\\}} SSM_{p-1, j-1}+ssm(\\{p..i\\}) \\end{align}\] <p>Start conditions:</p> \[\\begin{align} SSM_{i,1} &amp;:= ssm(1..i) CB_{i,1} &amp;:= 1 \\end{align}\] <p>Thus</p> \[\\begin{align} SSM_{i,i} &amp;:= sqr(\\{1..i\\}) \\\\ CB_{i,i} &amp;:= i \\\\ \\end{align}\] <p>Note that <strong><em>CB</em></strong><sub><strong><em>i,j</em></strong></sub> and <strong><em>SSM</em></strong><sub><strong><em>i,j</em></strong></sub> are only defined for <strong><em>j</em></strong> = <strong><em>i</em></strong> thus <strong><em>i</em></strong> - <strong><em>j</em></strong> = 0. Furthermore, for finding values with indices (<strong><em>n</em></strong>,<strong><em>k</em></strong>), only elements with <strong><em>i</em></strong> - <strong><em>j</em></strong> = <strong><em>n</em></strong> - <strong><em>k</em></strong> are relevant.</p> <ul> <li>If <strong><em>i</em></strong> = <strong><em>CB</em></strong><sub><strong><em>n</em></strong>, <strong><em>k</em></strong></sub> then the corresponding previous class-break index has been stored as <strong><em>CB</em></strong><sub><strong><em>i</em></strong> - 1, <strong><em>k</em></strong> - 1</sub>.</li> </ul> <!-- --> <ul> <li>Fisher described an algorithm that goes through all i and for each i finding and storing all <strong><em>SSD</em></strong><sub><strong><em>i,j</em></strong></sub> and <strong><em>CB</em></strong><sub><strong><em>i,j</em></strong></sub> for each subsequent j, which is the approach taken in the found implementations (see links). This requires <strong><em>O(k × n)</em></strong> working memory and <strong><em>O(k × n <sup>2</sup>)</em></strong> time.</li> </ul> <!-- --> <ul> <li>Dynamically going through all j and for each j finding all <strong><em>SSM<sub>i,j***</sub> for each i only requires **</em>O(n-k)</strong>* working memory and <strong><em>O(k × n × log(n))</em></strong> time by exploiting the no-crossing-paths characteristic, as proven below, but only provides the last ClassBreak for each i.</li> </ul> <!-- --> <ul> <li>no crossing paths property: <strong><em>CB</em></strong><sub><strong><em>i</em></strong>, <strong><em>j</em></strong></sub>is monotonous increasing with i, thus <strong><em>i1</em></strong> = <strong><em>i2</em></strong> ? <strong><em>CB</em></strong><sub><strong><em>i</em></strong>1, <strong><em>j</em></strong></sub> = <strong><em>CB</em></strong><sub><strong><em>i2, j</em></strong></sub> (see proof below).</li> </ul> <!-- --> <ul> <li>To obtain a chain of <strong><em>CB</em></strong><sub><strong><em>i,j</em></strong></sub> back from <strong><em>CB</em></strong><sub><strong><em>n</em></strong>, <strong><em>k</em></strong></sub>, one needs to maintain (<strong><em>n - k + 1</em></strong>) × (<strong><em>k - 2</em></strong>) intermediate CB’s, unless the <strong><em>O(k × nlog(n))</em></strong> algorithm is reapplied k times.</li> </ul> <h1 id="complexity"> <a href="#complexity" class="anchor-heading" aria-labelledby="complexity"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> complexity </h1> <ul> <li>Each <strong><em>ssm</em></strong>(<strong><em>i<sub>1</sub>..i<sub>2***</sub>) can be calculated in constant time as $\frac{\left(WV[i_2] - WV[i_1-1]\right)^2}{W[i_2] - W[i_1-1]}$ after a single initialization of **</em>O(n)</strong>* time and keeping a buffer of <strong><em>O(n)</em></strong> size containing series of cumulative weights, <strong><em>W</em></strong>, and cumulative weighted values, <strong><em>WV</em></strong>.</li> </ul> <!-- --> <ul> <li>During the calculation of the <strong><em>n - k + 1</em></strong> relevant values of SSM and CB for a row <strong><em>j ? {2..k - 1}</em></strong> using the <strong><em>n - k + 1</em></strong> values that were calculated for row <strong><em>j - 1</em></strong>, one can divide and conquer recursively by calculating <strong><em>CB<sub>i***, ***j***</sub> for i in the middle of a range for which a left and right boundary are given and using the “no crossing paths” property to cut the remaining number of options in half by sectioning the lower indices to the left or equal options and the higher indices to the greater or equal options. The required processing time budget **</em>C(n,m)</strong>* for processing <strong><em>n</em></strong> class-breaks using <em>m</em> values for previous class breaks is <strong><em>c</em></strong> × <strong><em>m</em></strong> + max <strong><em>i</em></strong> : [<strong><em>C(n/2,i)+C(n/2,m+1-i)</em></strong>]. A budget of <strong><em>C(n,m)</em></strong> := <strong><em>c × (m + n ) × (log<sub>2</sub>(n)+1)</em></strong> is sufficient, thus the calculation of <em><strong>CB<sub>i, j***</sub> given all ***CB<sub>i, j - 1***</sub> requires processing time of ***C(n,n)</strong></em>, which is <strong><em>O(n * logn)</em></strong>.</li> </ul> <h1 id="proof-of-the-no-crossing-paths-property"> <a href="#proof-of-the-no-crossing-paths-property" class="anchor-heading" aria-labelledby="proof-of-the-no-crossing-paths-property"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> proof of the no crossing paths property </h1> <p>Addition: the no crossing paths property might be equivalent to what elsewhere is called the convex Monge condition, which allows for the found speed-up of solving a dynamic programming problem.</p> <ul> <li>Given indices <strong><em>p1</em></strong>, <strong><em>p2</em></strong>, <strong><em>i1</em></strong>, <strong><em>i2</em></strong> such that <strong><em>p1</em></strong> &lt; <strong><em>p</em></strong>2 = <strong><em>i</em></strong>1 &lt; ***i2,</li> </ul> \[\\begin{align} m_p &amp;:= m(\\{p1 .. p2-1\\}) &amp;w_p &amp;:= w(\\{p1 .. p2-1\\}) \\\\ m_j &amp;:= m(\\{p2 .. i1 \\}) &amp;w_j &amp;:= w(\\{p2 .. i1 \\}) \\\\ m_n &amp;:= m(\\{i1+1 .. i2\\}) &amp;w_n &amp;:= w(\\{i1+1 .. i2\\}) \\\\ m_{pj} &amp;:= m(\\{p1 .. i1 \\}) &amp;w_{pj} &amp;:= w(\\{p1 .. i1\\}) \\\\ m_{jn} &amp;:= m(\\{p2 .. i2 \\}) &amp;w_{jn} &amp;:= w(\\{p2 .. i2\\}) \\\\ m_{pjn} &amp;:= m(\\{p1 .. i2 \\}) &amp;w_{pjn} &amp;:= w(\\{p1 .. i2\\}) \\\\ \\end{align}\] <ul> <li>it follows that</li> </ul> <p>\(v_{p1} \&lt; v_{p2} \\le v_{i1} \&lt; v_{i2} \\\\ m_p \&lt; m_{pj} \&lt; m_j \&lt; m_{jn} \&lt; m_n \\\\ m_{pj} \&lt; m_{pjn} \&lt; m_{jn}\) \(\\begin{align} w_{pj} &amp;= w_p + w_j \\\\ w_{jn} &amp;= w_j + w_n \\\\ w_{pjn} &amp;= w_p + w_j + w_n = w_{pj}+w_{jn} - w_j \\\\ \\end{align}\) \(\\begin{align} w_{pj} \\times m_{pj} &amp;= w_p \\times m_p + w_j \\times m_j \\\\ w_{jn} \\times m_{jn} &amp;= w_j \\times m_j + w_n \\times m_n \\\\ w_{pjn} \\times m_{pjn} &amp;= w_j \\times m_j + w_n \\times m_n + w_n \\times m_n \\\\ w_{pj} \\times m_{pj}+w_{jn} \\times m_{jn} &amp;= w_j \\times m_j + w_{pjn} \\times m_{pjn} \\end{align}\) \(\\begin{align} ssm(\\{p1 .. i1\\}) &amp;= w_{pj} \\times m_{pj}^2 \\\\ ssm(\\{p2 .. i1\\}) &amp;= w_{j} \\times m_{j}^2 \\\\ ssm(\\{p1 .. i2\\}) &amp;= w_{pjn} \\times m_{pjn}^2 \\\\ ssm(\\{i1 .. i2\\}) &amp;= w_{jn} \\times m_{jn}^2 \\end{align}\)</p> <ul> <li>and it follows that the following quantities are positive:</li> </ul> \[\\begin{align} w_{pj1} &amp;:= w_j \\times (m_{jn} - m_{j}) / (m_{jn} - m_{pj}) &amp;&gt; 0 \\\\ w_{jn1} &amp;:= w_j \\times (m_{j} - m_{pj}) / (m_{jn} - m_{pj}) &amp;&gt; 0 \\\\ w_{pj3} &amp;:= w_{pj} - w_{pj1} &amp;&gt; 0\\\\ w_{jn3} &amp;:= w_{jn} - w_{jn1} &amp;&gt; 0\\\\ \\end{align}\] <ul> <li>note that</li> </ul> \[\\begin{align} w_{pj1}+w_{jn1} &amp;= w_j \\\\ w_{pj3}+w_{jn3} &amp;= w_{pjn} \\\\ w_{pj1}+w_{pj3} &amp;= w_{pj} \\\\ w_{jn1}+w_{jn3} &amp;= w_{jn} \\\\ \\\\ w_{pj1} \\times m_{pj} + w_{jn1} \\times m_{jn} &amp;= w_j \\times m_j \\\\ w_{pj3} \\times m_{pj} + w_{jn3} \\times m_{jn} &amp;= w_{pj} \\times m_{pj}+w_{jn} \\times m_{jn}-w_j \\times aj = w_{pjn} \\times m_{pjn} \\end{align}\] <ul> <li>and therefore</li> </ul> \[\\begin{align} w_{pj1} \\times (m_{pj} - m_j )^2 &amp;+ w_{jn1} \\times (m_{jn} - m_j )^2 &amp;= w_{pj1} \\times m_{pj}^2 &amp;+ w_{jn1} \\times m_{jn}^2 - w_{j} \\times m_{j}^2 &amp;&gt; 0 \\\\ w_{pj3} \\times (m_{pj} - m_{pjn})^2 &amp;+ w_{jn3} \\times (m_{jn} - m_{pjn})^2 &amp;= w_{pj3} \\times m_{pj}^2 &amp;+ w_{jn3} \\times m_{jn}^2 - w_{pjn} \\times m_{pjn}^2 &amp;&gt; 0 \\end{align}\] <ul> <li>summation of these two inequalities gives:</li> </ul> <p>***w<sub>pj***</sub> × ***m<sub>pj**<em>&lt;/sub&gt;<sup>2</sup> + <strong>**w<sub>jn***</sub> × ***m<sub>jn***</sub><sup>2</sup> - ***w<sub>j***</sub> × ***m<sub>j</sub><sup>2</sup></strong></em> - ***w<sub>pjn<em>**&lt;/sub&gt; × **</em>m<sub>pjn</sub><sup>2***</sup> &gt; 0</sub></sub></p> <ul> <li>thus</li> </ul> <p><em><strong>w<sub>jn***</sub> × ***m<sub>jn***</sub><sup>2</sup> - ***w<sub>j</sub></strong></em> × ***m<sub>j</sub><sup>2<em>**&lt;/sup&gt; &gt; **</em>w<sub>pjn<em>**&lt;/sub&gt; × **</em>m<sub>pjn<em>**&lt;/sub&gt;<sup>2</sup> - **</em>w<sub>pj<em>**&lt;/sub&gt; × **</em>m<sub>pj***</sub><sup>2</sup></sub></sub></sub></sup></p> <ul> <li>which can be restated as</li> </ul> <p><strong><em>ssm</em></strong>({<strong><em>p2</em></strong>.<strong><em>i2</em></strong>}) - <strong><em>ssm</em></strong>({<strong><em>p2</em></strong>..<strong><em>i1</em></strong>}) &gt; <strong><em>ssm</em></strong>({<strong><em>p1</em></strong>..<strong><em>i2</em></strong>}) - <strong><em>ssm</em></strong>({<strong><em>p1</em></strong>..<strong><em>i1</em></strong>})</p> <ul> <li>given that : <em>S<strong>S</strong>M</em><sub><em>i</em>1, <em>j</em></sub> = <em>S<strong>S</strong>M</em><sub><em>p</em>2 - 1, <em>j</em> - 1</sub> + <em>s<strong>s</strong>m</em>({<em>p</em>2..<em>i</em>1}) = <em>S<strong>S</strong>M</em><sub><em>p</em>1 - 1, <em>j</em> - 1</sub> + <em>s<strong>s</strong>m</em>({<em>p</em>1..<em>i</em>1}) for all <em>p</em>1 &lt; <em>p</em>2 when <em>p</em>2 is taken as <em>C**B</em><sub><em>i</em>1, <em>j</em></sub>,</li> <li>adding the last two inequalities results in:</li> </ul> <p><strong><em>SSM<sub>p2*** - 1, ***j*** - 1</sub> + **</em>ssm</strong><em>({</em><strong>p2..i2</strong><em>}) &gt; <strong>*SSM</strong></em><sub><strong><em>p1</em></strong> - 1, <strong><em>j</em></strong> - 1</sub> + <strong><em>ssm</em></strong>({<strong><em>p1..i2</em></strong>}) for all <strong><em>n</em></strong> = <strong><em>i</em></strong></p> <ul> <li>given the definition for <strong><em>CB</em></strong>, this implies that <strong><em>CB</em></strong><em><sub><strong>*i2, j</strong>*</sub> cannot be p1 and therefore <strong>*CB<sub>i2, j***</sub> = ***p2</strong> = **</em>CB<sub>i1, j***</sub>, QED.</li> </ul> <h1 id="further-improvements"> <a href="#further-improvements" class="anchor-heading" aria-labelledby="further-improvements"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> further improvements </h1> <p>Note that</p> <ul> <li>for each <strong><em>i</em></strong>, and <strong><em>j</em></strong> &lt; <strong><em>i</em></strong>: <strong><em>SSM</em></strong><sub><strong><em>i,j</em></strong></sub> &lt; <strong><em>SSM</em></strong><sub><strong><em>i,j</em></strong> + 1</sub> since splitting up any class would make the total <strong><em>SSM</em></strong> larger.</li> <li>it is not always true that <strong><em>SSM</em></strong><sub><strong><em>i,j</em></strong></sub> &lt; = <strong><em>SSM</em></strong><sub><strong><em>i + 1,j</em></strong></sub>, for example, take <strong><em>v</em></strong><sub>1</sub> = - 10 and <strong><em>v</em></strong><sub>2</sub> = 0, then <strong><em>SSM</em></strong><sub>1, 1</sub> = 1 × (-10)<sup>2</sup> = 100 and <strong><em>SSM</em></strong><sub>2, 1</sub> = 2 × (-5)<sup>2</sup> = 50</li> <li>From the previous paragraph, it follows that:</li> </ul> <p><strong><em>ssm</em></strong>({<strong><em>p2..i2</em></strong>}) - <strong><em>ssm</em></strong>({<strong><em>p1..i2</em></strong>}) &gt; <strong><em>ssm</em></strong>({<strong><em>p2..i1</em></strong>}) - <strong><em>ssm</em></strong>({<strong><em>p1..i1</em></strong>})</p> <ul> <li>for each <strong><em>i1</em></strong>, <strong><em>i2</em></strong> &gt; <strong><em>i1</em></strong> and <strong><em>j</em></strong> &lt; <strong><em>i1</em></strong>:</li> </ul> <p><strong><em>SSM</em></strong><sub><strong><em>i2</em></strong>, <strong><em>j + 1</em></strong></sub> - <strong><em>SSM</em></strong><sub><strong><em>i2</em></strong>, <strong><em>j</em></strong></sub> = <strong><em>SSM</em></strong><sub><strong><em>i1</em></strong>, <strong><em>j</em></strong> + 1</sub> - <strong><em>SSM</em></strong><sub><strong><em>i1</em></strong>, <strong><em>j</em></strong></sub>, which can be proven by induction.</p> <p>following the lines of the latter induction proof it can be shown (elaborate!) that for each <strong><em>i</em></strong> and <strong><em>j</em></strong> &lt; <strong><em>i</em></strong>: <strong><em>CB</em></strong><sub><strong><em>i,j</em></strong></sub> = <strong><em>CB</em></strong><sub><strong><em>i,j</em></strong> + 1</sub>, thus <strong><em>CB</em></strong><sub><strong><em>i,j</em></strong></sub> can be used as a lower bound when calculating <strong><em>CB</em></strong><sub><strong><em>i</em></strong>, <strong><em>j + 1</em></strong></sub>.</p> <h1 id="previously-known-algorithms"> <a href="#previously-known-algorithms" class="anchor-heading" aria-labelledby="previously-known-algorithms"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> previously known algorithms </h1> <ul> <li>Iteratively moving values from classes with high variation to classes with low variation is discussed on Wikipedia, which does not always result in an optimal solution. Start for example with Class 1 with (1 4) and Class 2 with (99 100). The described algorithms prescribes that 4 needs to go to Class 2 since Class 1 has the highest variation.</li> </ul> <!-- --> <ul> <li>Local moves as long as the total sum of squared deviations decreases (as described in the <a href="http://support.esri.com/en/knowledgebase/techarticles/detail/26442">ESRI FAQ</a>). Note that this has the risk of sticking to a local optimum. For example when starting with Class 1 = {1, 8, 9, 10} and Class 2 = {16}, the SSD = 50. When moving the 10 to class 2, the SSD increases to 56, but the global minimum is reached when Class 1 = (1) and Class 2 = (8, 9, 10, 16) with an SSD of 38.75.</li> </ul> <h1 id="source-code"> <a href="#source-code" class="anchor-heading" aria-labelledby="source-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> source code </h1> <p>Source code is part of the <a href="https://github.com/ObjectVision/GeoDMS">GeoDms</a> and can be found <a href="calcnaturalbreaks">calcnaturalbreaks</a> or in our GitHub Repository, look for the function <a href="https://github.com/ObjectVision/GeoDMS/blob/main/clc/dll/src1/CalcClassBreaks.cpp">ClassifyJenksFisher()</a>.</p> <h1 id="acknowledgements"> <a href="#acknowledgements" class="anchor-heading" aria-labelledby="acknowledgements"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> acknowledgements </h1> <p>This algorithm and proof of its validity and complexity is found by Maarten Hilferink, also being the author of this page. © Object Vision BV. The work for developing this method has partly been made possible by a software development request from the <a href="http://www.pbl.nl_PBL_Netherlands_Environmental_Assessment_Agency"><a href="http://www.pbl.nl">http://www.pbl.nl</a> PBL Netherlands Environmental Assessment Agency</a>.</p> <h1 id="references"> <a href="#references" class="anchor-heading" aria-labelledby="references"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> references </h1> <ul> <li>Fisher, W. D. (1958). On grouping for maximum homogeneity. American Statistical Association Journal, 53, 789-798.</li> <li>Jenks, G. F. (1977). Optimal data classification for choropleth maps, Occasional paper No. 2. Lawrence, Kansas: University of Kansas, Department of Geography.</li> <li>Evans, I.S. (1977). The selection of class intervals. Transactions of the Institute of British Geographers, 2:98-124.</li> <li><a href="https://arxiv.org/pdf/1701.07204.pdf">https://arxiv.org/pdf/1701.07204.pdf</a></li> <li><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5148156/">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5148156/</a></li> <li><a href="https://link.springer.com/content/pdf/10.1007%2FBF02574380.pdf">https://link.springer.com/content/pdf/10.1007%2FBF02574380.pdf</a></li> <li><a href="https://en.wikipedia.org/wiki/SMAWK_algorithm">https://en.wikipedia.org/wiki/SMAWK_algorithm</a></li> </ul> <h1 id="links"> <a href="#links" class="anchor-heading" aria-labelledby="links"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> links </h1> <ul> <li><a href="http://en.wikipedia.org/wiki/Jenks_natural_breaks_optimization">http://en.wikipedia.org/wiki/Jenks_natural_breaks_optimization</a> (WikiPedia)</li> <li><a href="http://danieljlewis.org/2010/06/07/jenks-natural-breaks-algorithm-in-python">http://danieljlewis.org/2010/06/07/jenks-natural-breaks-algorithm-in-python</a></li> <li><a href="http://danieljlewis.org/files/2010/06/Jenks.pdf">http://danieljlewis.org/files/2010/06/Jenks.pdf</a></li> <li><a href="http://www.biomedware.com/files/documentation/spacestat/interface/map/classify/About_natural_breaks.htm">http://www.biomedware.com/files/documentation/spacestat/interface/map/classify/About_natural_breaks.htm</a></li> <li><a href="http://marc.info/?l=r-sig-geo&amp;m=118536881101239">http://marc.info/?l=r-sig-geo&amp;m=118536881101239</a></li> <li><a href="http://code.google.com/p/geoviz/source/browse/trunk/common/src/main/java/geovista/common/classification/ClassifierJenks.java?spec=svn634&amp;r=634">http://code.google.com/p/geoviz/source/browse/trunk/common/src/main/java/geovista/common/classification/ClassifierJenks.java?spec=svn634&amp;r=634</a></li> <li><a href="http://www.tandfonline.com/doi/abs/10.1080/01621459.1958.10501479">http://www.tandfonline.com/doi/abs/10.1080/01621459.1958.10501479</a></li> <li><a href="http://www.casa.ucl.ac.uk/martin/msc_gis/evans_class_intervals.pdf">http://www.casa.ucl.ac.uk/martin/msc_gis/evans_class_intervals.pdf</a></li> <li><a href="http://cran.r-project.org/web/packages/classInt/classInt.pdf">http://cran.r-project.org/web/packages/classInt/classInt.pdf</a></li> <li><a href="http://www.srnr.arizona.edu/rnr/rnr419/publications/jenks_caspall_1971.pdf">http://www.srnr.arizona.edu/rnr/rnr419/publications/jenks_caspall_1971.pdf</a></li> </ul> </main> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
